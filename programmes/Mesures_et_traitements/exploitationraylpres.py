# -*- coding: utf-8 -*-
"""
Created on Wed Mar 27 16:08:19 2013

Code pour extraire la mesure de susceptibilité d'une mesure
en chambre anéchoïque ou en chambre réverbérante

@author: emmanuel.amador@edf.fr
"""
from __future__ import division
from numpy import *
from pylab import *

Bleu= "#0084d1"
Rouge= "#c5000b"

OrangeEDF="#fe5815"
OrangeclairEDF="#ffa02f"
VertclairEDF="#c4d600"
VertEDF="#509e2f"
BleuclairEDF="#005bbb"
BleuEDF="#001a70"


def Susceptibility(filename,level,axe): 
    result=load(filename)
    angles=result['Angles']
    N=10#len(angles)
    consigne=result['Champconsigne']
    niveauxconsigne=consigne[0,0,:]
    f=result['f']
    champ=result['Champ']
    Susc=ones((N,len(f),len(niveauxconsigne)))    
    niveauxEz=zeros((N,len(f)))
    for i in range(0,N): #boucle sur les positions du mat
        for j in range(0,len(f)): #boucle sur les fréquences
            for k in range(0,len(niveauxconsigne)): #boucle sur les puissances injectées
                if (champ[i,j,k,axe]<level):
                    Susc[i,j,k]=0
                    niveauxEz[i,j]=niveauxconsigne[k]
    niv=mean(consigne[:,:,:],axis=0)
    prob=mean(Susc,axis=0)
    mask=(ones_like(prob)*(prob>0.6))
    mprob = ma.masked_array(prob,mask)
    Es=(2*niv*sqrt(log(1/mprob)/pi)).min(axis=1)
    return f,Es

axe=1 #axe de la sonde choisi pour l'immunité x=0, y=1, z=2
Ec=10 #niveau qui provoque un dysfonctionnement $E_c$

fca82,Esca82=Susceptibility('essai_CA_0.8-2.npz',Ec,axe)
fca24,Esca24=Susceptibility('essai_CA_2-4.npz',Ec,axe)    
fcrbm82,Escrbm82=Susceptibility('essai_CRBM_0.8-2.npz',Ec,axe)  
fcrbm24,Escrbm24=Susceptibility('essai_CRBM_2-4.npz',Ec,axe)  

#Figures
fig1=figure(num=1,figsize=(8,4))
plot(fca82/1e6,Esca82,OrangeEDF,lw=2,label=r'$E_{s_{CA}}$')
plot(fca24/1e6,Esca24,OrangeEDF,lw=2)
plot(fcrbm82/1e6,Escrbm82,VertEDF,lw=2,label=r'$E_{s_{CRBM}}$')
plot(fcrbm24/1e6,Escrbm24,VertEDF,lw=2)
#xlabel(r'$f$/MHz')
ylabel('V/m')
grid('on')
xlim(800,4000)
ylim(0,200)
legend(loc=0)
fig1.savefig('mesures_a10pres.pdf')

fig2=figure(num=2,figsize=(8,5))
plot(fca82/1e6,(Esca82/Escrbm82),BleuclairEDF,linestyle='none',marker='o', markersize=6)
plot(fcrbm24/1e6,(Esca24/Escrbm24),BleuclairEDF,linestyle='none',marker='o', markersize=6)
grid('on')
xlim(800,4000)
ylim(0,3.5)
xlabel(r'$f$/MHz')
ylabel(r'$E_{s_{CA}}/E_{s_{CRBM}}$')
fig2.savefig('mesures_b10pres.pdf')

